<!DOCTYPE html>
<html>
  <head>


    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 400px;
        width: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
    </style>

    <title>HateDate</title>
    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_include_tag "application"  %>
  </head>



  <body>

    <header class="site-header">
      <h1 class="logo"> HateDate</h1>


      <nav class="site-nav">
          <%= link_to("Surveys", surveys_path) %>
        <% if current_user %>
          <%= link_to("Profile Page", user_path(current_user)) %>
          <%= link_to("Matches", user_matches_path(current_user)) %>
          <%= link_to("Meetups", user_meetups_path(current_user)) %>
          <%= link_to "Logout", :logout, method: :delete %>

        <% else %>
          <%= link_to "Register", new_user_path %>
          <%= link_to "Login", :login %>
        <% end %>

      </nav>
    </header>
    <main>

   <% if flash[:notice] %>
      <p class="notice"><%=  flash[:notice]%></p>
    <% end %>
   <% if flash[:alert] %>
    <p class="alert"><%= flash[:alert] %></p>
  <% end %>

  <%= yield %>

<!-- ========== Google Maps ============== -->
    <div id="map"></div>

    <%=tag("div", :id => 'fsa_data', :data => {:fsa => @fsa_array})%>

    <% if current_user%>
    <%=tag("div", :id => 'current_guy', :data => {:latitude => current_user.fsa.latitude, :longitude => current_user.fsa.longitude}) %>
    <% end %>

    <script>
      var loggedUserLatLng = document.getElementById('current_guy');
      var loggedUserLat = JSON.parse(loggedUserLatLng.dataset.latitude);
      var loggedUserLng = JSON.parse(loggedUserLatLng.dataset.longitude);

      // console.log(loggedUserLatLng);
      // console.log(loggedUserLat);
      // console.log(loggedUserLng);


      var map;
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 43.647219, lng: -79.387905},
          zoom: 12,
          styles: purple
        });


        var marker = new google.maps.Marker({
         position: {lat: 43.647219, lng: -79.387905},
         map: map,
         title: 'Hello World!'
        });

       var fsaElement = document.getElementById('fsa_data');
       var fsaData = JSON.parse(fsaElement.dataset.fsa);
       // console.warn(fsaData);
       var fsaPopulations = {}

       for (i = 0; i < fsaData.length; i ++) {
         var currentFsa = fsaData[i];
         if (fsaPopulations[currentFsa['fsa_name']] > 0) {
           fsaPopulations[currentFsa['fsa_name']] += 1;
         } else {
           fsaPopulations[currentFsa['fsa_name']] = 1;
         }
       }

       for (var key in fsaPopulations) {
         count = fsaPopulations[key]
         later = 0.0;
         longer = 0.0;
         for (i = 0; i < fsaData.length; i ++) {
           if (key === fsaData[i].fsa_name) {
             later = fsaData[i].lat;
             longer = fsaData[i].lng;
           }
           new google.maps.Circle({
             strokeColor: 'deeppink',
             strokeOpacity: 0.3,
             strokeWeight: 2,
             fillColor: 'deeppink',
             fillOpacity: 0.05,
             center: {lat: later, lng: longer},
             map: map,
             radius: count * count * 100 + 100
           });
         }
       }


       var differenceCoordinates = [
         {lat: loggedUserLat, lng: loggedUserLng},
         {lat: 43.647219, lng: -79.387905},
       ];
       var differenceLine = new google.maps.Polyline({
         path: differenceCoordinates,
         geodesic: true,
         strokeColor: 'deeppink',
         strokeOpacity: 1.0,
         strokeWeight: 4
       });

       differenceLine.setMap(map);
     }

    </script>
    <!-- ========== Google Maps End ============== -->

    <script src="https://maps.googleapis.com/maps/api/js?key=<%=ENV["Google_key"]%>&callback=initMap"
    async defer></script>
    </main>

</body>
</html>
