<!DOCTYPE html>
<html>
  <head>


    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 400px;
        width: 100%;
      }
      /* Optional: Makes the sample page fill the window. */
    </style>

    <title>HateDate</title>
    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_include_tag "application"  %>
  </head>



  <body>

    <header class="site-header">
      <h1 class="logo"> HateDate</h1>


      <nav class="navbar">
        <div class="header-buttons">
          <table>
            <tr>
              <td class="tab-cols">
                <%= link_to("Surveys", surveys_path) %>
              </td>
              <% if current_user %>

              <td class="tab-cols">
                <%= link_to("Profile Page", user_path(current_user)) %>
              </td>
              <td class="tab-cols">
                <%= link_to("Matches", user_matches_path(current_user)) %>
              </td>
              <td class="tab-cols">
                <%= link_to("Meetups", user_meetups_path(current_user)) %>
              </td>
              <td class="tab-cols">
                <%= link_to "Logout", :logout, method: :delete %>
              </td>
              <td>
                <%= form_for current_user, url: change_status_path(current_user.id)  do |f|%>
                <%= f.label :status %>
                <%= f.select :status, ['Online', 'Busy', 'Available'], {}, {:onChange=>"this.form.submit()"} %>
                <%end %>
              </td>
              <% else %>

              <td class="tab-cols">
                <%= link_to "Register", new_user_path %>
              </td>
              <td class="tab-cols">
                <%= link_to "Login", :login %>
              </td>
              <% end %>
              <td class="search-bar">
                <%= form_tag find_user_path, :method => 'get' do %>
                <p>
                  <%= text_field_tag :search, params[:search], placeholder: "Pet Peeves" %>
                  <%= submit_tag "Search", :title => nil %>
                </p>
                <%end %>
              </td>
            </tr>
          </table>
        </div>

      </nav>
    </header>
    <main>

   <% if flash[:notice] %>
      <p class="notice"><%=  flash[:notice]%></p>
    <% end %>
   <% if flash[:alert] %>
    <p class="alert"><%= flash[:alert] %></p>
  <% end %>

  <%= yield %>

<!-- ========== Google Maps ============== -->


    <div id="map"></div>


    <% @fsa_array = [] %>
    <% User.all.each do |user|%>
      <%if user.fsa && user.privacy == false %>
        <% hasher = { fsa_name: user.fsa.name, lat: user.fsa.latitude, lng: user.fsa.longitude}  %>
        <% @fsa_array << hasher %>
        <% end %>
    <% end %>
    <%=tag("div", :id => 'fsa_data', :data => {:fsa => @fsa_array})%>


    <% if current_user&.fsa %>
      <% @user_array = [] %>
      <% User.all.each do |user|%>
      <% if user.fsa  && user.privacy == false%>
        <% hasher = {} %>
        <% hasher[:id] = user.id %>
        <% hasher[:fsa_name] = user.fsa.name %>
        <% hasher[:latitude] = user.fsa.latitude %>
        <% hasher[:longitude] = user.fsa.longitude %>
        <% @user_array << hasher %>
        <%end %>
      <% end %>
    <% end %>

    <%=tag("div", :id => 'user_locations', :data => {:user_location => @user_array})%>

    <% if current_user&.fsa %>
      <%=tag("div", :id => 'current_guy', :data => {:latitude => current_user.fsa.latitude, :longitude => current_user.fsa.longitude}) %>

    <% end %>

    <% if current_user&.fsa %>
      <%@matches_array =[] %>
      <%current_user.results.each do |result| %>
        <%result.matches.each do |match| %>
          <% User.all.each do |user| %>
          <%if match[0].to_i == user.id %>
            <% if user.fsa%>
              <% hasher = {} %>
              <% hasher[:id] = user.id %>
              <% hasher[:fsa_name] = user.fsa.name %>
              <% hasher[:latitude] = user.fsa.latitude %>
              <% hasher[:longitude] = user.fsa.longitude %>
              <%@matches_array << hasher %>
              <%end %>
            <%end %>
          <%end %>
        <%end %>
      <%end %>
    <%end %>

    <%=tag("div", :id => 'current_matches', :data => {:matches_location => @matches_array})%>
<!-- ========== Google Maps End ============== -->

    </main>

</body>
</html>
